generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum role {
  client
  freelancer
  admin
}

model user {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  full_name String   @db.VarChar(255)
  username  String   @unique @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  role      role     @default(client)
  avatar_url String? @db.Text
  bio       String?  @db.Text
  country   String?  @db.VarChar(255)
  status    Boolean  @default(true)
  is_active Boolean  @default(true)

  profiles              profile[]
  gigs                  gig[]
  buyer_orders           order[]        @relation("orders_buyer")
  seller_orders          order[]        @relation("orders_seller")
  wallets               wallet[]
  sent_conversations     conversation[] @relation("seller_conv")
  received_conversations conversation[] @relation("buyer_conv")
  reviews_given          review[]       @relation("reviewer")
  reviews_received       review[]       @relation("reviewee")
  notifications          notification[]
  payments_made          payment[]      @relation("payments_buyer")
  messages               message[]
  disputes               dispute[]      @relation("dispute_raisedBy")
  admin_logs             admin_log[]    @relation("admin_logs_user")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("users")
}

model profile {
  id           BigInt  @id @default(autoincrement()) @db.BigInt
  user         user    @relation(fields: [user_id], references: [id])
  user_id      BigInt  @db.BigInt
  title        String  @db.VarChar(255)
  hourly_rate  Decimal @db.Decimal(10, 2)
  skills       String? @db.Text
  language     String? @db.VarChar(255)
  profile_url  String? @db.Text
  availability String? @db.VarChar(255)
  rating_avg   Float?
  total_reviews Int?   @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("profiles")
}

model gig {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  user          user      @relation(fields: [user_id], references: [id])
  user_id       BigInt    @db.BigInt
  title         String    @db.VarChar(255)
  description   String?   @db.Text
  category      category? @relation(fields: [category_id], references: [id])
  category_id   BigInt?   @db.BigInt
  price_basic   Decimal?  @db.Decimal(10, 2)
  price_standard Decimal? @db.Decimal(10, 2)
  price_premium Decimal?  @db.Decimal(10, 2)
  delivery_days Int?
  revisions     Int?
  thumbnail_url String?   @db.Text
  images_json   String?   @db.Text
  status        String?   @db.VarChar(100)

  orders     order[]
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("gigs")
}

model category {
  id          BigInt      @id @default(autoincrement()) @db.BigInt
  name        String      @db.VarChar(255)
  description String?     @db.Text
  icon_url    String?     @db.Text
  parent      category?   @relation("CategoryToCategory", fields: [parent_id], references: [id])
  parent_id   BigInt?     @db.BigInt
  children    category[]  @relation("CategoryToCategory")

  gigs gig[]

  @@map("categories")
}

model order {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  buyer         user     @relation("orders_buyer", fields: [buyer_id], references: [id])
  buyer_id      BigInt   @db.BigInt
  seller        user     @relation("orders_seller", fields: [seller_id], references: [id])
  seller_id     BigInt   @db.BigInt
  gig           gig      @relation(fields: [gig_id], references: [id])
  gig_id        BigInt   @db.BigInt
  status        String   @db.VarChar(100)
  amount        Decimal  @db.Decimal(12, 2)
  delivery_date DateTime?
  payments      payment[]
  reviews       review[]
  disputes      dispute[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("orders")
}

model payment {
  id             BigInt        @id @default(autoincrement()) @db.BigInt
  order          order         @relation(fields: [order_id], references: [id])
  order_id       BigInt        @db.BigInt
  buyer          user          @relation("payments_buyer", fields: [buyer_id], references: [id])
  buyer_id       BigInt        @db.BigInt
  amount         Decimal       @db.Decimal(12, 2)
  status         String        @db.VarChar(100)
  method         String?       @db.VarChar(100)
  transaction    transaction?  @relation(fields: [transaction_id], references: [id])
  transaction_id BigInt?       @db.BigInt

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("payments")
}

model wallet {
  id           BigInt        @id @default(autoincrement()) @db.BigInt
  user         user          @relation(fields: [user_id], references: [id])
  user_id      BigInt        @unique @db.BigInt
  balance      Decimal       @default("0.00") @db.Decimal(14, 2)
  currency     String        @db.VarChar(10)
  transactions transaction[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("wallets")
}

model transaction {
  id         BigInt      @id @default(autoincrement()) @db.BigInt
  wallet     wallet      @relation(fields: [wallet_id], references: [id])
  wallet_id  BigInt      @db.BigInt
  type       String      @db.VarChar(50)
  amount     Decimal     @db.Decimal(12, 2)
  reference  String?     @db.VarChar(255)
  payments   payment[]

  created_at DateTime @default(now())

  @@map("transactions")
}

model conversation {
  id             BigInt      @id @default(autoincrement()) @db.BigInt
  buyer          user        @relation("buyer_conv", fields: [buyer_id], references: [id])
  buyer_id       BigInt      @db.BigInt
  seller         user        @relation("seller_conv", fields: [seller_id], references: [id])
  seller_id      BigInt      @db.BigInt
  messages       message[]
  last_message_id BigInt?    @db.BigInt
  last_message   message?    @relation("lastMessage", fields: [last_message_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("conversations")
}

model message {
  id              BigInt       @id @default(autoincrement()) @db.BigInt
  conversation    conversation @relation(fields: [conversation_id], references: [id])
  conversation_id BigInt       @db.BigInt
  sender          user         @relation(fields: [sender_id], references: [id])
  sender_id       BigInt       @db.BigInt
  content         String?      @db.Text
  attachments     String?      @db.Text
  is_read         Boolean      @default(false)
  sent_at         DateTime     @default(now())
  conversations   conversation[] @relation("lastMessage")

  @@map("messages")
}

model review {
  id          BigInt  @id @default(autoincrement()) @db.BigInt
  order       order   @relation(fields: [order_id], references: [id])
  order_id    BigInt  @db.BigInt
  reviewer    user    @relation("reviewer", fields: [reviewer_id], references: [id])
  reviewer_id BigInt  @db.BigInt
  reviewee    user    @relation("reviewee", fields: [reviewee_id], references: [id])
  reviewee_id BigInt  @db.BigInt
  rating      Int
  comment     String? @db.Text

  created_at DateTime @default(now())

  @@map("reviews")
}

model notification {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  user       user     @relation(fields: [user_id], references: [id])
  user_id    BigInt   @db.BigInt
  title      String   @db.VarChar(255)
  message    String   @db.Text
  type       String?  @db.VarChar(100)
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("notifications")
}

model dispute {
  id          BigInt  @id @default(autoincrement()) @db.BigInt
  order       order   @relation(fields: [order_id], references: [id])
  order_id    BigInt  @db.BigInt
  raised_by   user    @relation("dispute_raisedBy", fields: [raised_by_id], references: [id])
  raised_by_id BigInt @db.BigInt
  reason      String? @db.Text
  evidence    String? @db.Text
  status      String? @db.VarChar(100)
  resolution  String? @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("disputes")
}

model admin_log {
  id           String   @id @default(uuid()) @db.Uuid
  admin        user     @relation("admin_logs_user", fields: [admin_id], references: [id])
  admin_id     BigInt   @db.BigInt
  action       String   @db.VarChar(100)
  target_id    String?  @db.Uuid
  target_type  String?  @db.VarChar(20)
  created_at   DateTime @default(now())

  @@map("admin_logs")
}
